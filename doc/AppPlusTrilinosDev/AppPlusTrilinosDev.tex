\documentclass[pdf,ps2pdf,11pt]{SANDreport}
\usepackage{pslatex}
%Local stuff
\usepackage{graphicx}
\usepackage{latexsym}
%\usepackage{color}
\usepackage[all]{draftcopy}
\input{rab_commands}

\raggedright

% If you want to relax some of the SAND98-0730 requirements, use the "relax"
% option. It adds spaces and boldface in the table of contents, and does not
% force the page layout sizes.
% e.g. \documentclass[relax,12pt]{SANDreport}
%
% You can also use the "strict" option, which applies even more of the
% SAND98-0730 guidelines. It gets rid of section numbers which are often
% useful; e.g. \documentclass[strict]{SANDreport}

% ---------------------------------------------------------------------------- %
%
% Set the title, author, and date
%

\title{\center
Nightly Building and Testing of Development versions of Applications and
Trilinos }
\author{
Roscoe Bartlett \\
Laboratories\footnote{ Sandia is a multiprogram laboratory operated by Sandia
Corporation, a Lockheed-Martin Company, for the United States Department of
Energy under Contract DE-AC04-94AL85000.}, Albuquerque NM 87185 USA
}

% ---------------------------------------------------------------------------- %
% Set some things we need for SAND reports. These are mandatory
%
\SANDnum{SAND2007-xxx}
\SANDprintDate{??? 2007}
\SANDauthor{
Roscoe Bartlett
}

% ---------------------------------------------------------------------------- %
% The following definitions are optional. The values shown are the default
% ones provided by SANDreport.cls
%
\SANDreleaseType{Unlimited Release}
%\SANDreleaseType{Not approved for general release}

% ---------------------------------------------------------------------------- %
% The following definition does not have a default value and will not
% print anything, if not defined
%
%\SANDsupersed{SAND1901-0001}{January 1901}

% ---------------------------------------------------------------------------- %
%
% Start the document
%
\begin{document}

\maketitle

% ------------------------------------------------------------------------ %
% An Abstract is required for SAND reports
%

%\clearpage

%
%\begin{abstract}
%

%ToDo: Fill this in!

%
%\end{abstract}
%

% ------------------------------------------------------------------------ %
% An Acknowledgement section is optional but important, if someone made
% contributions or helped beyond the normal part of a work assignment.
% Use \section* since we don't want it in the table of context
%
%\clearpage
%\section*{Acknowledgment}
%
%
%The format of this report is based on information found
%in~\cite{Sand98-0730}.

% ------------------------------------------------------------------------ %
% The table of contents and list of figures and tables
% Comment out \listoffigures and \listoftables if there are no
% figures or tables. Make sure this starts on an odd numbered page
%
%\clearpage
\tableofcontents
%\listoffigures
%\listoftables

% ---------------------------------------------------------------------- %
% An optional preface or Foreword
%\clearpage
%\section{Preface}
%Although muggles usually have only limited experience with
%magic, and many even dispute its existence, it is worthwhile
%to be open minded and explore the possibilities.

% ---------------------------------------------------------------------- %
% An optional executive summary

%\clearpage

%\section{Executive Summary}

% ---------------------------------------------------------------------- %
% An optional glossary. We don't want it to be numbered
%\clearpage
%\section*{Nomenclature}
%\addcontentsline{toc}{section}{Nomenclature}
%\begin{itemize}
%\item[alohomora]
%spell to open locked doors and containers
%\end{itemize}

% ---------------------------------------------------------------------- %
% This is where the body of the report begins; usually with an Introduction
%

\SANDmain % Start the main part of the report

%
\section{Introduction}
%

During the course of the ASC Level-2 Vertical Integration Milestone work
[???], we found that in order to keep moving forward and avoid backslides in
capability (which happened early on), we needed to implement nightly building
and testing of the development versions of Charon and Trilinos
{}\cite{ref:trilinos}.  Every night, we take what is in the Charon and
Trilinos development repositories and build the combined Charon {}\& Trilinos
application and run a large set of regression tests.

In the execution of this nightly building and testing process, we have learned
many things about how to do continuous integration
{}\cite{continuous-integration} of application and algorithms (Trilinos)
software and we have realized many important unplanned benefits.  This will
allow us to reap many more benefits in the future if this process is
maintained and extended.  There are both production-related benefits and
research-related benefits that help both the application developers and the
algorithm developers to achieve their goals.  On the research side, this
significantly reduces the overhead required for algorithm developers to try
their algorithms out on production quality problems.  Developing a numerical
solver with a production problem exposes the algorithm developer to a whole
host of issues (e.g.\ poor scaling, ill-conditioning, difficult convergence,
etc.) that are hard to replicate in model problems.  On the production side,
constant integration insures that the application and Trilinos are always up
to date and satisfying the application's requirements.  Therefore, when it is
time for a release, only a final set of acceptance tests are required and then
the codes can be branched and released shortly after.  This helps to reduce a
whole host of risks such as slipped schedules and broken
features\footnote{Also known as regressions}.

We have seen several different scenarios over the years where this nightly
building and testing infrastructure would have facilitated collaboration
between application and algorithm developers for the advantage of both.

For example, suppose an application developer is running a new problem and
discovers some strange behavior from a numerical solver.  The algorithm
developer may look at the results and speculate what the cause of the behavior
might be or if a different variation of the algorithm might help.  However, if
the algorithm developer is stuck having to use a released version of Trilinos,
it will be more difficult to make any major changes in order to investigate
the behavior.  Also, there may already be improvements made to the algorithm
in the development branch of Trilinos that may be able to address the problem.
Without the infrastructure of nightly building and testing, it may not be cost
effective or practical to bring the development versions of the application
and Trilinos up to date in order to try the updated algorithm.  The algorithm
and application developers may have to wait until the next major release of
Trilinos before the new algorithms can be tried.  This time delay works to no
one's advantage and can kill the collaboration.  With nightly building and
testing in place, an easy path for collaboration is maintained where the
Trilinos algorithm developer can try their latest and greatest algorithms on
these types of challenging production problems and the information learned
from trying to solve these production problems can feed back into algorithm
development.  To some extent, this back and forth already happens but without
a foundational process in place to streamline it, this bidirectional flow is
greatly restricted.

Another example where nightly building and testing of the development versions
of the application and Trilinos would ease the path for collaboration is when
an application developers wants to try a new capability in Trilinos without a
lot of work\footnote{This example really happened and it was the inability to
readily access the development version of Trilinos within the application
that killed the collaboration}.  When the up-to-date development version of
Trilinos is available from within an application, a new algorithm or
capability from Trilinos can be accessed much more easily.  Typically, even a
small increase in the overhead needed to try out a new Trilinos capability in
an application can be enough to kill a potentially fruitful collaboration
between an application and algorithm developer.  Nightly building and testing
of the development versions of the application and Trilinos removes a
unexciting (and therefore demoralizing) but critical obstacle to collaboration
and impact.

Nightly building and testing of an application code and Trilinos
brings algorithm developers and application developers closer together --
exchanging ideas and concerns -- and refocuses Trilinos developers on customer 
efforts while still helping drive publishable numerical algorithm solver
research and reduces barriers for new algorithms to have impact through
production application codes.

For the reminder of this paper, we will refer to the combined development
versions of the application (e.g.\ Charon, Xyce, Alegra etc.) and Trilinos as
APP \& Trilinos Dev.


%
{}\section{Outline of proposed APP \& Trilinos Dev development and nightly
building and testing}
%

The basic idea of this new approach goes like this (which is mostly what we
already do with Charon \& Trilinos Dev right now):

{}\textit{\textbf{APP developers mainly work with APP \& Trilinos Release}}:
The developers of APP (e.g. Charon, Alegra, SIERRA) would only do their
production development and run their production test suite against a recent
stable released version of Trilinos.

{}\textit{\textbf{Trilinos developers mainly work with Trilinos Dev}}: Most of
the developers of Trilinos would do their development mostly just within
Trilinos and run the Trilinos test suite.  If radical changes are make, then
there should be a way for Trilinos developers to build and run APP \& Trilinos
Dev and it~s test suite to see if anything is broken (before a check in).
This will require some effort to set up and maintain for each APP (see below
practices).

{}\textit{\textbf{Hide APP \& Trilinos Dev ``research'' work in APP behind
ifdefs}}: Any ``research'' development done in APP against Trilinos Dev must
be hidden behind {}\#ifdefs so as not to impact the other production-focused
development work being done with APP that relies on the more stable release of
Trilinos.

{}\textit{\textbf{Nightly testing of APP \& Trilinos Release and APP \& Trilinos
Dev}}: Every night the following builds and tests would be done:

  \begin{itemize}

  {}\item\textit{\textbf{APP \& Trilinos Release tested against ``production''
  test suite}}: The Dev version of APP would be built and tested against the
  static/stable current release of Trilinos.

    \begin{itemize}

    {}\item\textit{\textbf{Send ``production'' failures only to APP
    developers}}: Test failures for APP \& Trilinos Release are only forwarded
    to APP developers, not Trilinos developers.  It is possible that latent
    defects in the current release of Trilinos may be the cause of the
    failure, but this should be unlikely.

    \end{itemize}

  {}\item\textit{\textbf{APP \& Trilinos Dev tested against ``research'' and
  ``production'' test suites}}: The combined APP \& Trilinos Dev code with
  enabled {}\#ifdefs and extended ``research'' test suite would be built and
  tested (both ``production'' and ``research'' tests).

    \begin{itemize}

    {}\item\textit{\textbf{Only send ``production'' failures that did not also
    fail in APP \& Trilinos Release to Trilinos developers (representative)}}:
    Only ``production'' tests that failed in this version that did not fail in
    the production APP version would be forwarded to Trilinos developers
    (e.g. to the dedicated APP \& Trilinos Dev representative, see below).

    {}\item\textit{\textbf{Send ``research'' failures only to Trilinos
    developers (representative)}}: By default, average APP developers would
    not see (i.e. in daily emails) these ``research'' test failures (unless
    they wanted to in which case they could be added to an email list).

    \end{itemize}

  {}\item\textit{\textbf{Summary: Minimize unnecessary interaction between APP
  and Trilinos development activities}}\footnote{We did not have unnecessary
  interactions totally under control for Charon \& Trilinos Dev during the
  milestone work and it resulted in some waisted time.  See the practices for
  how this can be addressed.}: Using the policies Jescribed above, APP
  developers are less likely to be bothered with defects introduced by
  Trilinos developers and Trilinos developers are less likely to be bothered
  with defects introduced by APP developers.
                
  \end{itemize}

{}\textit{\textbf{Release of APP \& Trilinos together or staged }}: A release
of the APP \& Trilinos would go one of two routes:

    \begin{itemize}

    {}\item\textit{\textbf{a) Combined tagging and release of APP \&
    Trilinos}}: Right before a release of APP, the APP and Trilinos would be
    tagged and branched at the same time to make sure both are as current as
    possible.  This could be very challenging to pull off.

    {}\item\textit{\textbf{b) Staggered releases of APP \& Trilinos}}: APP
    developers make a decision to target a release of APP against a very
    recent release of Trilinos.  At the point of the release of Trilinos, the
    Dev version of APP drops support for older release of Trilinos, moves code
    from within the protected {}\#ifdefs into main Dev build and then any new
    work with Trilinos Dev is hidden behind new {}\#ifdefs.

    \end{itemize}

{}\textit{\textbf{Continue APP \& Trilinos Dev nightly building and testing after
APP release}}: After a release of APP, using any of the approach approaches,
the nightly building of APP \& Trilinos Dev continues where incompatibilities
between Dev versions of APP and Trilinos are hidden behind new {}\#ifdefs.


%
{}\section{Suggested practices to support proposed APP \& Trilinos Dev
development and nightly building and testing}
%

Several practices need to be in place in order to make this all work in the
most effective way:

{}\textit{\textbf{Separate ``production'' and ``research'' tests}}: Any new
test or example added to APP's test suite based on post-release features in
Trilinos Dev must be added as new ``research'' tests as not to affect existing
``production'' tests.  In this way, we can easily differentiate between
``production'' regression tests and new ``research'' or ``pre-production'' tests.
This will not be full-proof in differentiating defects in APP code verses
Trilinos code, but this will go a long way in helping to suggest where the
problem is..

{}\textit{\textbf{Maintain a dedicated machine for building and testing APP \&
Trilinos Dev}}: Having a dedicated, powerful machine for supporting APP \&
Trilinos Dev would make it easy to maintain an environment to build and test
APP \& Trilinos Dev.  It would also enable Trilinos developers a quick and easy
way to access, build and test APP \& Trilinos Dev.  Issues like keeping third
party libraries up to date would only need to be handled on this one machine.
Accounts would be granted as needed and would only require SRN access.  This
would allow any Trilinos or APP developer with an SRN account to quickly log
onto the dedicated machine, and then be able to quickly build APP \& Trilinos
Dev and run the ``research'' and ``production'' test suites.  Some helper
scripts and examples also need to be in place to show how to do this.

{}\textit{\textbf{Appoint a dedicated APP \& Trilinos representative}}: One member
of the Trilinos or APP development teams should be designated as the point
person for the APP \& Trilinos Dev effort.  This person would be responsible
for filtering test failures and forwarding issues to APP or Trilinos
developers.  This person must be familiar with the APP and Trilinos for this
to be effective.  Ideally, this person will be a co-developer of APP and
Trilinos, so there would be little-to-no learning curve.  Having only one
person be responsible (with perhaps a backup person in their absences) will
make it clear who is responsible for making sure issues are dealt with in a
timely manner.  This person would take the major responsibility of maintaining
the dedicated APP \& Trilinos machine described above. The goal is that this
job should not take too much effort if everyone else is doing their jobs well.
However, this job could be a nightmare if this effort is not taken seriously
by everyone involved (including management).

{}\textit{\textbf{Provide easy access for any Trilinos or APP developer to build,
test, and develop APP \& Trilinos Dev}}: Trilinos and APP developers need a
quick and painless way to build APP \& Trilinos Dev in order to diagnose and
fix failures.  This may include the ability to checkout and change APP code to
fix the problem.  Of course, modified APP code would need to go through a
thorough code review by APP developers before it was checked into APP's code
repository.  Likewise, an APP developer should be able to change and fix
Trilinos code if they where so motivated.  Again, a code review by Trilinos
developers should be done before an APP developer checks in any code changes
to Trilinos.  Having a dedicated machine maintained by the APP \& Trilinos
representative as described above would make this easy to support.

{}\textit{\textbf{Transition of ``research'' to ``production'' after Trilinos
release}}: If a ``research'' algorithm or feature becomes stable enough and
the software implementation is of high enough quality (i.e. ``phase 2''
package in Trilinos), then after the next Trilinos release the ``research''
APP code and tests for that algorithm/feature should be moved to the APP's
``production'' code and tests.  In this way, if the test fails later, the APP
developers will be the first to face the bug since it is most likely an APP
developer that broke something.

{}\textit{\textbf{Perform APP \& Trilinos Release and Dev nightly testing on
same set of platforms}}\footnote{In the ASC Vertical Integration Milestone
work with Charon \& Trilinos Dev, we did not have this in place.  As a result,
there where several occasions that new ``production'' tests failed when run
with Charon \& Trilinos Dev that passed with Charon \& Trilinos Release on a
different platform.  Most of these ``production'' test failures where just due
to minor rounding or other porting issues.  The time waisted tracking down
these ``production'' test failures could have been avoided if we had this
policy in place.}: The nightly building and testing of APP \& Trilinos Release
and APP \& Trilinos Dev should be performed on the same set of platforms.  In
this way, if a ``production'' test fails with APP \& Trilinos Dev but not with
APP \& Trilinos Release on the same platform, then we have some assurance that
something has been broken by in the ``research'' work and not the
``production'' work being done by APP developer.  If testing is done on
different platforms, then a ``production'' test failure with APP \& Trilinos
Dev may just be do to small difference is rounding other other small issues
that result from using different platforms.

{}\textit{\textbf{Enable more communication between APP and Trilinos developers}}:
All of this will require and foster more communication and cooperation between
Trilinos and APP developers.  This means that we will have to have a closer
relationship with our customers.

{}\textit{\textbf{Provide for instantaneous releasabiliy of Trilinos to important
customers}}: In order to allow for the option of the Dev version of the APP and
Trilinos to be tagged and branched to be released together, the Trilinos
release process for such customers needs to be complete-able in only a few days
at most.  This will require a change in a great many of the current Trilinos
practices.  For example, this will require that we port Trilinos Dev to
various platforms where the APP runs on a frequent basis (perhaps every few
months or less).  Also, this will require that we have completely automated
tarball testing and installation testing.  There are other issues that would
also need to be changed and/or improved in how we develop Trilinos.


%
{}\section{Research and production advantages to nightly building and testing
of APP \& Trilinos Dev}
%

There are many research and production advantages to maintaining the nightly
building and testing of the development versions of production application and
Trilinos.


%
{}\subsection{Research advantages to nightly building and testing of APP \&
Trilinos Dev}
%

Here are some of the research advantages to maintaining the nightly building
and testing of the development versions of a production application and
Trilinos:

{}\textit{\textbf{Reduces overhead for initial algorithm integration}}: This
massively reduces the overhead needed for a Trilinos algorithms developer to
try out a new algorithm on a production quality problem implemented in APP.
One of the most difficult aspects of doing serious algorithm research is
having access to serious (possibly messy) production quality problems.

{}\textit{\textbf{Improves chances that new algorithms will have impact}}:
Reducing overhead of the software initial integration improves the chances
that a new algorithm or package will benefit a real application and therefore
show real ``impact'' which is always a criticism for 1400.  This is related to
the previous point but is worth mentioning by itself.

{}\textit{\textbf{Preserves interesting/challenging problems}}: This preserves
really interesting problems that will be constant drivers for future algorithm
research.  A really challenging problem that is encountered after an initial
algorithm integration and experimentation effort can be preserved so that
algorithm researchers can come back to it later again and again to try new
versions of their algorithms.  Spending a lot of effort to get an algorithm
integrated with some production code and then having that connection and the
working examples lost happens again and again with our current environment.
Even more important is the ability to show ``progress'' as our algorithms
improve by running them on the same basic production physics problems.


%
{}\subsection{Production advantages to nightly building and testing of APP \&
Trilinos Dev}
%

Here are some of the production advantages to maintaining the nightly building
and testing of the development versions of a production application and
Trilinos:

{}\textit{\textbf{Expands testing for Trilinos}}: The tests in the APP~s test
suite represents an extended test suite for Trilinos.  In our work with
Charon, we have already seen cases where the Charon test suite caught an error
that the Trilinos test suite did not.  Most APPs also build against an
installed version of Trilinos so nightly building and testing of APP \&
Trilinos Dev helps to test the installation of Trilinos which is very had to
do currently.

{}\textit{\textbf{Enables better scalability testing for Trilinos}}: Production
APPs provide ready access to large-scale parallel problems that can serve as a
vehicle for testing the parallel scalability of Trilinos algorithms.  Teuchos
timers make it easy to isolate timings for specific algorithm features.
Automated scripts can query these timings (from the output) and can catch any
problems with scalability that are seen.

{}\textit{\textbf{Reduces time to detection of defects}}: This is directly related
to expanded testing described in the above items but defects introduced in
Trilinos code between releases that break customer functionality (but may not
be caught by native Trilinos tests) will be caught right away.  Even if a test
failure is not fixed right away, knowing exactly when a test failed is an
extremely useful piece of information in being able to track down and fix the
defect later.  The cost of fixing defects increases the longer the time
between when the defect is introduced and the time it is first detected
{}\cite{book:code-complete-2}.  Daily testing reduces the risk that a release
of Trilinos will regress and/or helps to contain costs and the schedule if a
broken feature must be preserved in the next combined release of APP \&
Trilinos.

{}\textit{\textbf{Reduces release time and effort}}: It reduces (or eliminates)
the time needed to create a bundled release of APP \& Trilinos.  This removes
uncertainty about how long it will take to put out a release of Trilinos
and/or APP.  What is being done right now with Trilinos is the maintenance
version of the so called ``Big Bang'' integration approach
{}\cite{book:code-complete-2}.  Iterations of one year or even six months are
too long to call ``incremental'' integration if any significant develop is
being done in the APP or in Trilinos.

{}\textit{\textbf{Allows for more aggressive refactorings and code improvements}}:
It allows for more aggressive refactorings of Trilinos code since the impact
of the refactorings on important APP customers can be ascertained and fixed
right away.  This will allow the architecture to evolve as needed in a safer
and less demanding way.  The ability to refactor code is the number one issue
in making sure a code does not become ``legacy code''.  Without the ability to
refactor a code, you automatically insure that the code will be thrown away or
relegated to ``legacy code'' at some point {}\cite{book:code-complete-2}.

{}\textit{\textbf{Better address customer needs}}: This will bring Trilinos
algorithm developers closer to important Trilinos APP customers so that
customer needs can be addressed more effectively in a timely manner.

{}\textit{\textbf{Reduces all kinds of risk}}: Overall, this simply reduces all
kinds of risks, increases predictability of the development and release
process, and makes Trilinos more responsive to important customers.


%
{}\section{Potential disadvantages to nightly building and testing of APP \&
Trilinos Dev}
%

Here are some of the potential disadvantages to maintaining the nightly
building and testing of the development versions of a production application
and Trilinos:

{}\textit{\textbf{May slow down day-to-day development}}: It will slow down the
day-to-day development of Trilinos and the APP to some extent in that problems
are dealt with as they are uncovered by daily building and testing.

{}\textit{\textbf{Could increase overall development effort}}: It may increase the
overall development time for Trilinos if not managed well.  However,
experience by other projects and organizations suggests that the overall
development time and effort to create and maintain production capabilities
should actually decrease! {}\cite{book:code-complete-2}.

{}\textit{\textbf{Will require better, more coordinated management practices}}:
This will require some more sophisticated management practices and tools to
keep all of this running smoothly.  This will require some additional effort
over what is done now with more up-front effort to set up.

{}\textit{\textbf{Imposes greater responsibility to meet customer needs}}:
Trilinos developers will have a greater responsibility to meet important APP
customer needs.  A lot of algorithm researchers don~t want to sign up for that
kind of responsibility.  However, such individuals don~t have to write or
maintain production algorithmic capabilities.  There will always be a place
for more pure algorithms research.


%
\section{Conclusions}
%

There are a number of conclusions that we have drawn as a result of this
milestone work in relation to the proposed nightly building and testing of the
development versions of an application and Trilinos:

\begin{itemize}

{}\item Nightly building and testing of the development versions of the
application and Trilinos:

  \begin{itemize}

  {}\item results in better production capabilities and better research,

  {}\item brings algorithm developers and application developers closer
  together allowing for a better exchange of ideas and concerns,

  {}\item refocuses Trilinos developers on customer efforts,

  {}\item helps drive research-quality algorithm development, and
        
  {}\item reduces barriers for new algorithms to have impact on production
  applications.

  \end{itemize}

{}\item Other application projects and scientific support software projects
should consider adopting the type of continuous integration that is used with
Charon \& Trilinos that was developed as part of this milestone work.

\end{itemize}

% ---------------------------------------------------------------------- %
% References
%
\clearpage
\bibliographystyle{plain}
\bibliography{references}
\addcontentsline{toc}{section}{References}

% ---------------------------------------------------------------------- %
% Appendices should be stand-alone for SAND reports. If there is only
% one appendix, put \setcounter{secnumdepth}{0} after \appendix
%
%\appendix
%\input{???}

%\begin{SANDdistribution}
%\end{SANDdistribution}

\end{document}
