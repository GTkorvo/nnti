<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (X11; U; SunOS 4.1.3_U1 sun4m) [Netscape]">
   <META NAME="sandia.approved" CONTENT="SAND99-1377">
   <META NAME="author" CONTENT="karen devine, kddevin@sandia.gov">

   <TITLE>Zoltan User's Guide:  Load-Balancing Examples</TITLE>
<!
  ------------------------
  | CVS File Information |
  ------------------------
  $RCSfile$
  $Author$
  $Date$
  $Revision$
>
</HEAD>
<BODY BGCOLOR="#FFFFFF">

<DIV ALIGN=right>
<H3>
<IMG SRC="figures/ug_header.gif" ALT="Zoltan User's Guide" ></H3></DIV>

<H2>
<A NAME="Load-Balancing Example"></A>Load-Balancing Example</H2>
An example of the typical calling sequence for load balancing using Zoltan
in a finite element application is shown in the <A HREF="#LB Example Fig">figure</A>
below. An application first selects a load-balancing algorithm through a
call to <B><A HREF="ug_interface_lb.html#LB_Set_Method">LB_Set_Method</A></B>.
Appropriate query functions are then registered with the load-balancing
library through a series of calls to <B><A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A></B>.
In the example, a geometric algorithm, such as RCB, is assumed. Application
query functions returning lists and coordinates of nodes of the finite
element mesh are registered. Next, some parameter values are set by calls
to <B><A HREF="ug_interface_lb.html#LB_Set_Param">LB_Set_Param</A></B>.
After some computation, load balancing is
invoked by calling <B><A HREF="ug_interface_lb.html#LB_Balance">LB_Balance</A></B>.
The results of the load balancing include the number of nodes to be imported
and exported to the processor, lists of global and local IDs of the imported
and exported nodes, and source and destination processors of the imported
and exported nodes. The return value of <B><A HREF="ug_interface_lb.html#LB_Balance">LB_Balance</A></B>
is tested to see whether the new decomposition differs from the old one.
If the decompositions differ, some sort of data migration is needed to
establish the new decomposition; the details of migration are not shown
in this <A HREF="#LB Example Fig">figure</A> but will be addressed in the
<A HREF="ug_examples_mig.html">migration examples</A>. After the data migration
is completed, the arrays of information about imported and exported nodes
returned by <B><A HREF="ug_interface_lb.html#LB_Balance">LB_Balance</A></B>
are freed by a call to <B><A HREF="ug_interface_lb.html#LB_Free_Data">LB_Free_Data</A></B>.
Finally, when the application is all finished with the load balancing operations,
it calls <B><A HREF="ug_interface_lb.html#LB_Destroy_Object">LB_Destroy_Object</A></B>.
<BR>&nbsp;
<BR>&nbsp;
<CENTER><TABLE BORDER=2 COLS=1 WIDTH="90%" NOSAVE >
<TR>
<TD><A NAME="LB Example Fig"></A><TT>char *lb_method;</TT>&nbsp;
<BR><TT>int new, num_imp, num_exp, *imp_procs, *exp_procs;</TT>&nbsp;
<BR><TT><A HREF="ug_usage.html#Macro defs">LB_GID</A> *imp_global_ids,
*exp_global_ids;</TT>&nbsp;
<BR><TT><A HREF="ug_usage.html#Macro defs">LB_LID</A> *imp_local_ids, *exp_local_ids;</TT>&nbsp;

<P><TT>/* <I>Set load-balancing method.</I> */</TT>&nbsp;
<BR><TT>read_load_balancing_info_from_input_file(&amp;lb_method);</TT>&nbsp;
<BR><TT><A HREF="ug_interface_lb.html#LB_Set_Method">LB_Set_Method</A>(lb,
lb_method, &amp;(lb_params[0]));</TT>&nbsp;

<P><TT>/* <I>Register load-balancing query functions.</I> */</TT>&nbsp;
<BR><TT><A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_NUM_GEOM_FN">LB_NUM_GEOM_FN_TYPE</A>,
user_return_dimension, NULL);</TT>&nbsp;
<BR><TT><A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_GEOM_FN">LB_GEOM_FN_TYPE</A>,
user_return_coords, NULL);</TT>&nbsp;
<BR><TT><A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_NUM_OBJ_FN">LB_NUM_OBJ_FN_TYPE</A>,
user_return_num_node, NULL);</TT>&nbsp;
<BR><TT><A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_OBJ_LIST_FN">LB_OBJ_LIST_FN_TYPE</A>,
user_return_owned_nodes, NULL);</TT>&nbsp;

<P><TT>/* <I>Reset some load-balancing parameters.</I> */</TT>&nbsp;
<BR><TT><A HREF="ug_interface_lb.html#LB_Set_Param">LB_Set_Param</A>(lb, 
"imbalance_tol", "0.1");</TT>
<BR><TT><A HREF="ug_interface_lb.html#LB_Set_Param">LB_Set_Param</A>(lb, 
"RCB_Reuse", "TRUE");</TT>

<P><TT>/* <I>Perform computations</I> */</TT>&nbsp;
<BR><TT>...</TT>&nbsp;
<BR><TT>/* <I>Perform load balancing</I> */</TT>&nbsp;
<BR><TT><A HREF="ug_interface_lb.html#LB_Balance">LB_Balance</A>(lb,&amp;new,&amp;num_imp,&amp;imp_global_ids,&amp;imp_local_ids,&amp;imp_procs,</TT>&nbsp;
<BR><TT>&nbsp;&nbsp;&nbsp; &amp;num_exp,&amp;exp_global_ids,&amp;exp_local_ids,&amp;exp_procs);&nbsp;</TT>&nbsp;
<BR><TT>if (new)</TT>&nbsp;
<BR><TT>&nbsp; perform_data_migration(...);</TT>&nbsp;

<P><TT>/* <I>Free memory allocated for load-balancing results by LB library</I>
*/</TT>&nbsp;
<BR><TT><A HREF="ug_interface_lb.html#LB_Free_Data">LB_Free_Data</A>(&amp;imp_global_ids,
&amp;imp_local_ids, &amp;imp_procs,&nbsp;</TT>&nbsp;
<BR><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;exp_global_ids, &amp;exp_local_ids,
&amp;exp_procs);&nbsp;</TT>&nbsp;
<BR><TT>...</TT>
<BR><TT><A HREF="ug_interface_lb.html#LB_Destroy_Object">LB_Destroy_Object</A>
(&amp;lb);

<BR><TT>...</TT>

</TD>
</TR>

<CAPTION ALIGN=BOTTOM><I>Typical calling sequence for performing load balancing
with the Zoltan library.</I></CAPTION>
</TABLE></CENTER>
&nbsp;

<BR>&nbsp;
<CENTER><TABLE BORDER=2 COLS=1 WIDTH="90%" NOSAVE >
<TR>
<TD><TT>character(len=3) lb_method</TT>&nbsp;
<BR><TT>logical new</TT>&nbsp;
<BR><TT>integer(lb_int) num_imp, num_exp</TT>&nbsp;
<BR><TT>integer(lb_int), pointer :: imp_procs(:), exp_procs(:)</TT>&nbsp;
<BR><TT><A HREF="ug_fortran_api.html#fortran ug api IDs">type(LB_GID)</A>,
pointer :: imp_global_ids(:), exp_global_ids(:)
! app defined global IDs</TT>&nbsp;
<BR><TT>integer(lb_int), pointer :: imp_local_ids(:), exp_local_ids(:)
! integer local IDs</TT>&nbsp;
<BR><TT>integer(lb_int) ierr</TT>&nbsp;

<P><TT>! <I>Set load-balancing method.</I></TT>&nbsp;
<BR><TT>lb_method = "RCB"</TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_lb.html#LB_Set_Method">LB_Set_Method</A>(lb,
lb_method)</TT>&nbsp;

<P><TT>! <I>Register load-balancing query functions.</I></TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_NUM_GEOM_FN">LB_NUM_GEOM_FN_TYPE</A>,
user_return_dimension) ! omit data = C NULL</TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_GEOM_FN">LB_GEOM_FN_TYPE</A>,
user_return_coords)</TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_NUM_OBJ_FN">LB_NUM_OBJ_FN_TYPE</A>,
user_return_num_node)</TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_init.html#LB_Set_Fn">LB_Set_Fn</A>(lb, <A HREF="ug_query_lb.html#LB_OBJ_LIST_FN">LB_OBJ_LIST_FN_TYPE</A>,
user_return_owned_nodes)</TT>&nbsp;

<P><TT>! <I>Reset some load-balancing parameters.</I></TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_lb.html#LB_Set_Param">LB_Set_Param</A>(lb, 
"imbalance_tol", "0.1")</TT>
<BR><TT>ierr = <A HREF="ug_interface_lb.html#LB_Set_Param">LB_Set_Param</A>(lb, 
"RCB_Reuse", "TRUE")</TT>

<P><TT>! <I>Perform computations</I></TT>&nbsp;
<BR><TT>...</TT>&nbsp;
<BR><TT>! <I>Perform load balancing</I></TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_lb.html#LB_Balance">LB_Balance</A>(lb,new,num_imp,imp_global_ids,imp_local_ids,imp_procs, &amp;</TT>&nbsp;
<BR><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; num_exp,exp_global_ids,exp_local_ids,exp_procs)&nbsp;</TT>&nbsp;
<BR><TT>if (new) then</TT>&nbsp;
<BR><TT>&nbsp; perform_data_migration(...)</TT>&nbsp;
<BR><TT>endif</TT>&nbsp;

<P><TT>! <I>Free memory allocated for load-balancing results by LB library</I>
</TT>&nbsp;
<BR><TT>ierr = <A HREF="ug_interface_lb.html#LB_Free_Data">LB_Free_Data</A>(imp_global_ids,
imp_local_ids, imp_procs, &amp;&nbsp;</TT>&nbsp;
<BR><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exp_global_ids, exp_local_ids,
exp_procs)&nbsp;</TT>&nbsp;
<BR><TT>...</TT>
<BR><TT>call <A HREF="ug_interface_lb.html#LB_Destroy_Object">LB_Destroy_Object</A>(lb)

<BR><TT>...</TT>

</TD>
</TR>

<CAPTION ALIGN=BOTTOM><I>Fortran version of the load balancing
example.</I></CAPTION>
</TABLE></CENTER>
&nbsp;

<P>
<HR WIDTH="100%">[<A HREF="ug.html">Table of Contents</A>&nbsp; |&nbsp;
<A HREF="ug_examples_mig.html">Next:&nbsp; Migration Examples</A>&nbsp;
|&nbsp; <A HREF="ug_examples_init.html">Previous:&nbsp; Initialization
Example</A>]
</BODY>
</HTML>
