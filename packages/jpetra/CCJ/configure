#!/bin/sh

if [ x$CCJ_ROOT != x ]
then
	CCJ_ROOT_ENV=$CCJ_ROOT
fi

if [ -f configuration ]
then
        echo "Previous configuration read from file 'configuration'."
	echo "If you wish to discard the previous configuration,"
	echo "please remove or rename the file 'configuration'"
	echo "and run configure again."

	source configuration

	echo ""
	echo "Copied configuration:"
	cat configuration
	echo ""
fi

if [ x$CCJ_ROOT_ENV != x ]
then
	CCJ_ROOT=$CCJ_ROOT_ENV
elif [ x$CCJ_ROOT = x ]
then
	CCJ_ROOT=`pwd`
fi

if [ x$JAVA_ROOT = x ]
then
	javaexec=`which java`
	if [ -L $javaexec ]
	then
		javaexeclink=`ls -l $javaexec`
		javaexecpath=`expr "$javaexeclink" : '.*-> *\(.*\) *'`
		JAVA_BIN=`dirname $javaexecpath`
	else
		JAVA_BIN=`dirname $javaexec`
	fi
	JAVA_ROOT=`dirname $JAVA_BIN`
fi
if [ x$JAVAC = x ]
then
	JAVAC=$JAVA_ROOT/bin/javac
fi

if [ x$RMIC_LOWER = x ]
then
	version=`$JAVA_ROOT/bin/java -version 2>&1 | grep version | awk '{print $3}' | sed 's/"//g'`
	echo version $version
	RMIC_LOWER=`expr $version : '.*\.\(.*\).*'`
fi

if [ x$MANTA_ROOT = x ]
then
	MANTA_ROOT=/usr/local/VU/manta
fi

for i
do
	case $i in
	--java-root=*)
			JAVA_ROOT=`expr $i : '--java-root=\(.*\)'`
			;;
	--javac=*)
			JAVAC=`expr $i : '--javac=\(.*\)'`
			;;
	--ccj-root=*)
			CCJ_ROOT=`expr $i : '--ccj-root=\(.*\)'`
			;;
	--manta-root=*)
			MANTA_ROOT=`expr $i : '--manta-root=\(.*\)'`
			;;
	--help|-h|-?)
			echo configure [options]
			echo options:
			echo "	" option name "		" default
			echo "	" --java-root=PATH "	" $JAVA_ROOT
			echo "	" --javac=PATH "		" $JAVAC
			echo "	" --ccj-root=PATH "	" $CCJ_ROOT
			echo "	" --manta-root=PATH "	" $MANTA_ROOT
			echo "	" --rmic-lower=lo-version "" $RMIC_LOWER
			exit 0
			;;
	*)
			echo No such option: $i -- ignored
	esac
done

if [ -f config.mk ]
then
	cp config.mk config.mk.old
fi

if [ -f config.mk.orig ]
then
	diff -c config.mk.orig config.mk > .config.mk.diff
else
	rm -f .config.mk.diff
fi

sed -e "
s+@JAVA_ROOT@+$JAVA_ROOT+
s+@JAVAC@+$JAVAC+
s+@CCJ_ROOT@+$CCJ_ROOT+
s+@MANTA_ROOT@+$MANTA_ROOT+
s+@RMIC_LOWER@+$RMIC_LOWER+
" < config.in > config.mk

cp config.mk config.mk.orig
if [ -f .config.mk.diff ]
then
	patch -p0 < .config.mk.diff
	rm .config.mk.diff
fi

echo "
JAVA_ROOT=$JAVA_ROOT
JAVAC=$JAVAC
CCJ_ROOT=$CCJ_ROOT
MANTA_ROOT=$MANTA_ROOT
RMIC_LOWER=$RMIC_LOWER
" > configuration

echo "
Configuration in $CCJ_ROOT:
----------------------
java-root=$JAVA_ROOT
javac=$JAVAC
ccj-root=$CCJ_ROOT
manta-root=$MANTA_ROOT
----------------------
"

echo "Now configure $CCJ_ROOT/jg-bench"
echo ""

(cd jg-bench; \
	./configure \
		--java-root=$JAVA_ROOT \
		--javac=$JAVAC \
		--ccj-root=$CCJ_ROOT \
		--jgb-root=$CCJ_ROOT/jg-bench \
		--manta-root=$MANTA_ROOT \
		)
