#!/usr/bin/env python
import os
import sre
import os.path
import sys

#
#   Syntax:  GrepTimings Counter NumProcs Filename
#
#   where Filename is an ML output file containing performance numbers
#         NumProcs is the number of processors used to generate the output
#         Counter  indicates which one in the sequence of scaling this 
#         file corresponds to. That is, GrepTimings is normally used
#         repeatedly on a series of files. For the first file, Counter is
#         1, and the second file it is 2, etc.
#
# Note: GrepTimings is used by Ou/tmp/t2Matlab
#

args = sys.argv[1:]
if len(args) < 3:
   print '\n'
   print 'Usage: GrepTimings Counter NumProcs Filename'
   print '\n'
   sys.exit()

def myopen(filename,mode):
   """
      Open filename with mode (e.g. 'r', 'w'). If the file
      cannot be openned, print a message and exit. Return
      stream pointer.
   """
   try:
      fileptr = open( filename, mode )
   except IOError:
      print "Could not open ", filename
      sys.exit(2)
   return fileptr

def mysed(pattern,replacement,filein,fileout=sys.stdout):
   """
      Simple version of sed. Go through each line in the file
      'filein'. Find the first occurance in each line of the 
      regular expression given by 'pattern' and replace it with
      'replacement'. If 4th argument not given, put the output
      on stdout. Otherwise, open the file given by the 4th
      argument and put the output there.
   """
   fileToSearch = myopen(filein, 'r')
   #
   outstream = fileout
   if (fileout != sys.stdout):
      outstream = myopen( fileout, 'w' )
   #
   for line in fileToSearch.read().splitlines():
      outstream.write(sre.sub(pattern,replacement,line,1)+'\n')
   fileToSearch.close()
   if (fileout != sys.stdout): outstream.close()

def mygrep(pattern,filein,fileout=sys.stdout):
   """
      Simple version of grep. Go through each line in the file
      'filein'. Print each line which contains the regular expression 
      given by 'pattern'.  If 4th argument not given, put the output
      on stdout. Otherwise, open the file given by the 4th
      argument and put the output there.
   """
   fileToSearch = myopen(filein, 'r')
   #
   outstream = fileout
   if (fileout != sys.stdout):
      outstream = myopen( fileout, 'w' )
   #
   for line in fileToSearch.read().splitlines():
      if ( sre.search(pattern,line)):
        outstream.write(line+'\n')
   fileToSearch.close()
   if (fileout != sys.stdout): outstream.close()

def invgrep(pattern,filein,fileout=sys.stdout):
   """
      Simple version of grep -v. Go through each line in the file
      'filein'. Print each line which DOES NOT contains the regular expression 
      given by 'pattern'.  If 4th argument not given, put the output
      on stdout. Otherwise, open the file given by the 4th
      argument and put the output there.
   """
   fileToSearch = myopen(filein, 'r')
   outstream = fileout
   if (fileout != sys.stdout):
      outstream = myopen( fileout, 'w' )
   #
   for line in fileToSearch.read().splitlines():
      if ( sre.search(pattern,line) == None):
        outstream.write(line+'\n')
   fileToSearch.close()
   if (fileout != sys.stdout): outstream.close()


print 'Proc('+args[0]+') = '+args[1]+';'
mygrep( 'Amat_.*apply\+comm'    ,  args[2],'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep( 'min'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Amat_','AvMin'         ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
mygrep( 'max'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Amat_','AvMax'         ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
#
mygrep( 'Rmat_.*apply\+comm'    ,  args[2],'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep( 'min'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Rmat_','RMin'          ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$',';'                 ,'/tmp/t4'          ) # sends to stdout
mygrep( 'max'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Rmat_','RMax'          ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
#
mygrep( 'Pmat_.*apply\+comm'    ,  args[2],'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep( 'min'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Pmat_','PMin'          ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
mygrep( 'max'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Pmat_','PMax'          ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
#
mygrep( 'Amat_.*exch bdry time' ,  args[2],'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep( 'min'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Amat_','AvMinComm'     ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
mygrep( 'max'                   ,'/tmp/t1','/tmp/t2')
mysed(  'Amat_','AvMaxComm'     ,'/tmp/t2','/tmp/t3')
mysed(  ':.*=' ,'('+args[0]+')=','/tmp/t3','/tmp/t4')
mysed(  '$'    ,';'             ,'/tmp/t4'          ) # sends to stdout
#
mygrep( 'Rmat_.*exch bdry time' ,  args[2],'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep('min'                    ,'/tmp/t1','/tmp/t2')
mysed('Rmat_','RMinComm'        ,'/tmp/t2','/tmp/t3')
mysed(':.*=' ,'('+args[0]+')='  ,'/tmp/t3','/tmp/t4')
mysed('$',';'                   ,'/tmp/t4'          ) # sends to stdout
mygrep('max'                    ,'/tmp/t1','/tmp/t2')
mysed('Rmat_','RMaxComm'        ,'/tmp/t2','/tmp/t3')
mysed(':.*=' ,'('+args[0]+')='  ,'/tmp/t3','/tmp/t4')
mysed('$'    ,';'               ,'/tmp/t4'          ) # sends to stdout
#
mygrep('Pmat_.*exch bdry time'  ,args[2]  ,'/tmp/t0')
invgrep('artition'              ,'/tmp/t0','/tmp/t1')
mygrep('min'                    ,'/tmp/t1','/tmp/t2')
mysed('Pmat_','PMinComm'        ,'/tmp/t2','/tmp/t3')
mysed(':.*=' ,'('+args[0]+')='  ,'/tmp/t3','/tmp/t4')
mysed('$'    ,';'               ,'/tmp/t4'          ) # sends to stdout
mygrep('max'                    ,'/tmp/t1','/tmp/t2')
mysed('Pmat_','PMaxComm'        ,'/tmp/t2','/tmp/t3')
mysed(':.*=' ,'('+args[0]+')='  ,'/tmp/t3','/tmp/t4')
mysed('$'    ,';'               ,'/tmp/t4'          ) # sends to stdout
#
if ( os.path.isfile('/tmp/t0')): os.remove('/tmp/t0')
if ( os.path.isfile('/tmp/t1')): os.remove('/tmp/t1')
if ( os.path.isfile('/tmp/t2')): os.remove('/tmp/t2')
if ( os.path.isfile('/tmp/t3')): os.remove('/tmp/t3')
if ( os.path.isfile('/tmp/t4')): os.remove('/tmp/t4')
