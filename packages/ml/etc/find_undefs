#!/bin/sh

COMPILE=$1
COMP_FLAGS=$2
LINKER=$3
THELIBRARIES=$4
THEARCHS=$5

\rm -f capper .undefs .undefs2 .thedefs mygrep
${COMPILE} ${COMP_FLAGS} -o capper capper.c
${COMPILE} ${COMP_FLAGS} -o mygrep mygrep.c
everyone=`grep MLFORTRAN ../src/Utils/ml_lapack.h | \
		sed "s/^.*MLFORTRAN(/ /"| sed "s/).*/ /"`
${echo} "Figuring out blas/lapack dependencies"
for i in $everyone
    do
    all_but_me=`${echo} $everyone | sed "s/ $i / xxxx /" | \
		      sed "s/^$i /xxxx /" | sed "s/ $i$/ xxxx/"`
    \rm -f temprog.c .undefs .undefs2
    ${echo} -n "."
    ${echo} "#include \"ml_defs.h\"" >> temprog.c
    ${echo}  >> temprog.c
    ${echo} "void MLFORTRAN($i)(void);" >> temprog.c
    ${echo} "int main(int argc, char *argv[]){" >> temprog.c
    ${echo} "MLFORTRAN($i)(); return 0; }" >> temprog.c
    ${COMPILE} ${COMP_FLAGS} -I ../Obj -c temprog.c
    ${LINKER} ${COMP_FLAGS} temprog.o ${THELIBRARIES} ${THEARCHS} 2> .undefs
    bb=`cat .undefs | grep $i | wc | sed "s/^ *//" | sed "s/ .*//"`
    if test $bb -eq 0
       then
       NAME=`${echo} $i | ./capper`
       ${echo} "\\" >> .thedefs
       ${echo} -n "-DML_${NAME}_FUNC ">> .thedefs
    else
      cc=`cat .undefs | mygrep $all_but_me`
      if test $cc -eq 1
         then
         NAME=`${echo} $i | ./capper`
         ${echo} "\\" >> .thedefs
         ${echo} -n "-DML_${NAME}_FUNC ">> .thedefs
      fi
    fi
done
${echo} -DML_NOTHING >> .thedefs
${echo}

\rm -f capper mygrep .undefs .undefs2  temprog.c temprog.o a.out


