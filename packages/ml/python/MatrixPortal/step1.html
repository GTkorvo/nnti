<?php 
  include 'common/header.php';
  include 'common/util.php';
  setBodyAttributes('onload="grabFocus();"'); 
  setFilename('index.html');
  setTitle('Matrix Portal -- Step 1: Data Selection');
  setDir('./');
  include 'common/config.php';
  include 'common/header.html';

  process_variables();

  global $ProblemIDs;
  global $ResultIDs;

  if ($_POST['state'] == "add")
  {
    if ($_POST['MyLabel'] === "")
    {
      echo "<p><font color=red><b>Sorry, empty labels are not allowed.";
      echo "</b></font></p>";
    }
    else if (strstr($_POST['MyLabel'], ":") ||
             strstr($_POST['MyLabel'], "@") ||
             strstr($_POST['MyLabel'], ";") ||
             strstr($_POST['MyLabel'], "!") ||
             strstr($_POST['MyLabel'], "+") ||
             strstr($_POST['MyLabel'], "_"))
    {
      echo "<p><font color=red><b>Sorry, labels cannot contain : ; _ + or @";
      echo "</b></font></p>";
    }
    else
    {
      $ProblemIDs .= ":" . $_POST['MyLabel'] . "@" . $_POST['type'];
      foreach (split(" ", $_POST['parameters']) as $value)
      { 
        if ($value == "") continue;
        $ProblemIDs .= '_' . $value . '!' . $_POST[$value];
      }
    }
  }
  else if ($_POST['state'] == "uploadData")
  {
    $error = 0;
    $errorText = "";
  
    if (!$_POST['accessCode'] !== "this is the password") 
    {
      $errorText .= "Error: Wrong authorization code\n";
      $error++;
    }
    if (!is_uploaded_file($_FILES['file']['tmp_name'])) 
    {
      $errorText .= "Error: please supply a file.<br />\n";
      $error++;
    } 
    if (!$_POST['filename']) 
    {
      $errorText .= "Error: please provide a filename.<br />\n";
      $error++;
    } 
  
    if ($error) {
      echo "<div class=errorBox>";
      echo $errorText;
      echo "</div>";
    }
    else
    {
      $filename = $MatrixDirectory . $_POST['filename'];
      echo "<BR>" . $filename;
      move_uploaded_file($_FILES['file']['tmp_name'], $filename);
      chmod($filename, 0664);
    }
  }
?>

<!-- begin content ######################################################### -->

  <? step_header("1"); ?>

  You are at Step 1: Select Data.
  
  <!-- ===================================================================== -->
  
  <p>In this step, you should specify at least one problem to be solved.
  Each problem is identified by a <b>label</b> or <b>ProblemID</b> you have to select. There are two
  ways to supply problems: by selecting a matrix from the Matrix-Market or
  Harwell/Boeing repositories, or by using the matrix generator.
  Authorized users can upload their problems and add them to the already
  available matrices. The list of problems currently selected is reported in
  the <b>Current Settings</b> section. When you start, the list of <b>Recordered Results</b>
  is empty; you first need to go through step 4 to populate this array. A <b>result</b> is an 
  evaluation parameter for the solver you specified on a given problem.

  <p>To <b>continue</b>, proceed to Step 1C (Check Data) using the button at the
  bottom of the page.</font>


  <div class="problemIDs">
  <?php print_problem_and_result($ProblemIDs, $ResultIDs, 1); ?> 
  </div>

  <!-- ----------------------------------------------------------------- -->

  <p class="heading">Data from Generator:</p>
  
  <div class="formSection">
  <ol>
  
  <li>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm2DLaplace">

  2D Laplace on a 
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name=state value="add">
  <input type="hidden" name=parameters value="inx iny">
  <input type="hidden" name=type value="Laplace2D">
  <input type="text" name="inx" value=100 size=5> x
  <input type="text" name="iny" value=100 size=5> grid.
  <p>This creates a matrix corresponding to the stencil of a 2D Laplacian operator on a structured Cartesian grid. The matrix stencil is:
  <p><img src=common/laplace2d_stencil.png>

  <p>Label this problem as <input type="text" name=MyLabel size=10>&nbsp;then&nbsp;
  <input type=submit class=submitPrimary value="add to cart"><br></form>

  <br>
  <li>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm3DLaplace">

  3D Laplace on a 
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name=state value="add">
  <input type="hidden" name=parameters value="inx iny inz">
  <input type="hidden" name=type value="Laplace3D">
  <input type="text" name="inx" value=10 size=5> x
  <input type="text" name="iny" value=10 size=5> x
  <input type="text" name="inz" value=10 size=5> grid.
  <p>This creates a matrix corresponding to the stencil of a 3D Laplacian operator on a structured Cartesian grid.<br> 
  <p>Label this problem as <input type="text" name=MyLabel size=10>&nbsp;then&nbsp;
  <input type=submit class=submitPrimary value="add to cart"><br></form>

  <br>
  <li>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm2Dadwrf">

  2D advection-diffuction with recirculating flow, on a 
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name=state value="add">
  <input type="hidden" name=parameters value="inx iny dconv ddiff">
  <input type="hidden" name=type value="Recirc2D">
  <input type="text" name="inx" value=100 size=5> x
  <input type="text" name="iny" value=100 size=5> grid.<br>
  conv = <input type="text" name="dconv" value=1 size=5>&nbsp;
  diff = <input type="text" name="ddiff" value=1e-5 size=5>&nbsp;
  <p>This creates a matrix corresponding to the finite-difference discretization of the problem
  <p><img src=common/recirc1.png>
  <p>on the unit square, with homogeneous Dirichlet boundary conditions. A standard 5-pt stencil is used to discretize the diffusive term, and a simple upwind stencil is used for the convective term. Here,
 <p><img src=common/recirc2.png>

  <p>The value of epsilon can be specified using <tt>diff</tt>, and that of V 
  using <tt>conv</tt>.<br>

  <p>Label this problem as <input type="text" name=MyLabel size=10>&nbsp;then&nbsp;
  <input type=submit class=submitPrimary value="add to cart"><br></form>

  <br>
  <li>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm2Dadwrf">

  Generic 9-pt stencil
  <p><img src=common/star2d_stencil.png>
  <p>using the following values:
  <p>
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name=state value="add">
  <input type="hidden" name=parameters value="inx iny da db dc dd dz1 dz2 dz3 dz4">
  <input type="hidden" name=type value="Star2D">
  <input type="text" name="inx" value=100 size=5> x
  <input type="text" name="iny" value=100 size=5> grid.<br>
  a = <input type="text" name="da" value=8.0 size=5>&nbsp;
  b = <input type="text" name="db" value="-1.0" size=5>&nbsp;
  c = <input type="text" name="dc" value="-1.0" size=5>&nbsp;
  d = <input type="text" name="dd" value="-1.0" size=5>&nbsp;
  z1 = <input type="text" name="dz1" value="-1.0" size=5>&nbsp;
  z2 = <input type="text" name="dz2" value="-1.0" size=5>&nbsp;
  z3 = <input type="text" name="dz3" value="-1.0" size=5>&nbsp;
  z4 = <input type="text" name="dz4" value="-1.0" size=5>&nbsp;

  <p>Label this problem as <input type="text" name=MyLabel size=10>&nbsp;then&nbsp;
  <input type=submit class=submitPrimary value="add to cart"><br></form>

  </ol>

  </div>

  <!-- ----------------------------------------------------------------- -->

  <p class="heading">Data from Collections:</p>
  
  <div class="formSection">
  
  <ol>
  
  <li>
  Problems rsa from the Harwell/Boeing collection
  <p>

  <form action="#" enctype="multipart/form-data" method="post" name="inputForm">
  <?
    $files = array();
    $dir = opendir($MatrixDirectory) or die ($php_errormsg);
    while (false !== ($file = readdir($dir))) {
      if (is_file("$MatrixDirectory$file")) {
        $files[] = $file;
      }
    }
    closedir($dir);                  

    echo "<select name=type size=" . count($files) . '>';
        
      foreach ($files as $file) {
        echo "<option value=MM_" . $file . ">" . $file . "</option>";
      }
              
    echo "</select>";
  ?>

  <p>Label this problem as <input type="text" name=MyLabel size=10 value="">&nbsp;then&nbsp;

  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type="hidden" name=state value="add">

  <input type=submit class=submitPrimary value="add to cart"><br></form>
  </div>

  </div>
  <p>

  <!-- ----------------------------------------------------------------- -->

  <p class="heading">Upload Data (requires access code):

  <div class="formSection">
  <p>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm">
  
    <p class="subheading">Harwell/Boeing File:</p>
  
      <table class="formTable" cellspacing="0" cellpadding="0">
        <tr><td> <label for="file">Matrix or linear problem file:</label>
        </td><td> <input type="file" name="file" size="40" />
        </td></tr>
        <tr><td> <label for="filename">Filename on server:</label>
        </td><td> <input type="text" name="filename" size="40" />
        </td></tr>
        <tr><td> <label for="accessCode">Access Code:</label>
        </td><td> <input type=password name="accessCode" size="40" />
        </td></tr>
      </table><br />
  
      <!-- php marker for state in form process -->
      <input type="hidden" name="MAX_FILE_SIZE" value="2000000" />
      <input type="hidden" name="state" value="uploadData">
      <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
      <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
      <input type="submit" class=submitPrimary name="uploadButton" value="Upload" />
    </form>
  
  </div>
    
  <br>
  <p><form action="step1C.html" enctype="multipart/form-data" method="post" name="inputForm" id="inputForm">
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <input type=hidden name=ProblemIDs value="<? global $ProblemIDs; echo $ProblemIDs; ?>">
  <input type="hidden" name="perform_analysis" value="True">
  Continue to:
  <input type="submit" class=submitSecondary name="submit" value="Step 1C: Check Data" />
  
  </form>

  
  <!-- ===================================================================== -->  
<!-- end content ########################################################### -->

<?php include 'common/footer.html'; ?>
