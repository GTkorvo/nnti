<?php 
  include 'common/header.php';
  include 'common/util.php';
  includeStyleSheet('styles.css'); 
  setBodyAttributes('onload="grabFocus();"'); 
  setFilename('index.html');
  setTitle('Matrix Portal -- Step 4: Results');
  setDir('./');
  include 'common/config.php';
  include 'common/header.html';

  process_variables();

  global $ProblemIDs;
  global $ResultIDs;

  for ($i = 0; $i < $_POST['phi_count']; $i = $i + 1)
  {
    $value = $_POST['phi_value_'. $i];
    $label = $_POST['phi_label_'. $i];
    $ResultIDs .= ":$value@$label";
  }

  if ($_POST['ymin'] != "")
    $ymin = $_POST['ymin'];
  else
    $ymin = -1.0;

  if ($_POST['ymax'] != "")
    $ymax = $_POST['ymax'];
  else
    $ymax = -1.0;
?>

<!-- begin content ######################################################### -->

  <? step_header("4"); ?>

  You are at Step 4: Check Results.
  
  <p>Here you can analyze all results, in a table and graph format.

  <p>To <b>continue</b>, proceed to either Step 1 or Step 2, to select new
  problems, or to specify new solution techniques.

  <!-- --------------------------------------------------------------------- -->

  <br/>
  <div class="ProblemIDs">
  <p class=heading>Recordered results:</p>
  <p>
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm">
  <table cols=3 border=0>
  <tr>
  <td>Label</td>
  <td>PHI</td>
  <td>plot this value</td>
  </tr>
  <? 
    $count = 1;
    foreach (explode(':', $ResultIDs) as $i)
    {
      if ($i == "") continue;

      $j = explode('@', $i);
      echo "<tr><td><b>" . $j[1] . "</td><td>" . $j[0] . "</td>";
      echo "<td><input type=checkbox name=plot_" . $count++ . " value=Yes checked=checked>";
      echo "</td>";
      echo "</tr>";
    }
    ?>
  </table>
  
  <br/>
  <p>Limits for the Y-axis, set both to -1.0 for autoset
  <table><tr>
  <td>Y_min:</td><td>
  <input type=text name=ymin value="<? global $ymin; echo $ymin;?>"  size=10>
  </td></tr>
  <tr><td>Y_min:</td><td>
  <input type=text name=ymax value="<? global $ymax; echo $ymax;?>" size=10>
  </td></tr></table>
  <input type="hidden" name="ProblemIDs" value="<? global $ProblemIDs; echo $ProblemIDs; ?>" >
  <input type="hidden" name="ResultIDs" value="<? global $ResultIDs; echo $ResultIDs; ?>" >
  <br><input type=submit class=submitPrimary value="replot"><br>
  </form>
  </div>

  <b><center>
<?

{
$timestamp = date("y-m-d_H.i.s", time());
global $ymin;
global $ymax;

$myFile = $TempDirectory . "/gnuplot-" . $timestamp . '.dat';
$fh = fopen($myFile, 'w') or die("can't open file");

fwrite($fh, "set title 'evaluation'\n");
fwrite($fh, "set ylabel 'phi'\n");
fwrite($fh, "set terminal push\n");
fwrite($fh, "set terminal png\n");
fwrite($fh, "set autoscale\n");
fwrite($fh, "set output '" . $ImageDirectory . "/gnuplot-" . $timestamp . ".png'\n");
fwrite($fh, 'set xtics rotate ("" 0 ');
$count = 1;
$new_count = 1;
foreach (explode(':', $ResultIDs) as $i)
{
  if ($i == "") continue;
  if ($_POST['plot_' . $count] == "Yes")
  {
    $j = explode('@', $i);
    fwrite($fh, ', "' . $j[1] . '" ' . $new_count++ . " ");
  }
  $count++;
}
fwrite($fh, ")\n");
fwrite($fh, 'set xrange [0:' . ($new_count) . ']' . "\n");
if ($ymin != -1.0 && $ymax != 1.0)
  fwrite($fh, 'set yrange [' . $ymin . ':' . $ymax . ']' . "\n");
fwrite($fh, "set boxwidth 1\n");
fwrite($fh, "set style fill solid\n");
fwrite($fh, "set nokey\n");
fwrite($fh, "set boxwidth 0.8\n");
fwrite($fh, "plot '-' using 1:2 w boxes\n");
$count = 1;
$new_count = 1;
foreach (explode(':', $ResultIDs) as $i)
{
  if ($i == "") continue;
  if ($_POST['plot_' . $count] == "Yes")
  {
    $j = explode('@', $i);
    fwrite($fh, $new_count++ . " " . $j[0] . "\n");
  }
  $count++;
}
fwrite($fh, "end\n");

fwrite($fh, "set output\n");
fwrite($fh, "set terminal pop\n");

fclose($fh); 

if ($new_count != 1)
{
  passthru('/usr/bin/gnuplot /tmp/gnuplot-' . $timestamp . ".dat");
  echo '<IMG SRC=../tmp/gnuplot-' . $timestamp . '.png>';
}
}

?>

<!-- end content ########################################################### -->

<?php include 'common/footer.html'; ?>
