<?php 
  include 'common/header.php';
  include 'common/util.php';
  includeStyleSheet('styles.css'); 
  setBodyAttributes('onload="grabFocus();"'); 
  setFilename('index.html');
  setTitle('Trilinos - WebSolver - Step 4: Results');
  setDir('./');
  include 'common/header.html';

  $ProblemIDs = $_POST['ProblemIDs'];
  $ResultIDs = $_POST['ResultIDs'];

  for ($i = 0; $i < $_POST['phi_count']; $i = $i + 1)
  {
    $value = $_POST['phi_value_'. $i];
    $label = $_POST['phi_label_'. $i];
    $ResultIDs .= ":$value@$label";
  }
?>

<!-- begin content ######################################################### -->

  <p class="heading">Trilinos <a href="index.html">WebSolver</a> - Step 4: Results</p>
  
  <? step_header(); ?>

  <!-- --------------------------------------------------------------------- -->

  <br/>
  <div class="problemIDs">
  <? print_problem_and_result($ProblemIDs, $ResultIDs); ?>
  </div>

  <p>
  <center>
  <table cols=2 border=1>
  <tr>
  <td>Result label</td>
  <td>PHI</td>
  </tr>
  <? 
    foreach (explode(':', $ResultIDs) as $i)
    {
      if ($i == "") continue;

      $j = explode('@', $i);
      echo "<tr><td><b>" . $j[1] . "</td><td>" . $j[0] . "</td></tr>";
    }
    ?>
  </table>
  
<?

$timestamp = date("y-m-d_H.i.s", time());

$myFile = "/tmp/gnuplot-" . $timestamp . '.dat';
$fh = fopen($myFile, 'w') or die("can't open file");

fwrite($fh, "set title 'evaluation'\n");
fwrite($fh, "set ylabel 'phi'\n");
fwrite($fh, "set terminal push\n");
fwrite($fh, "set terminal png\n");
fwrite($fh, "set autoscale\n");
fwrite($fh, "set output '/var/www/html/tmp/gnuplot-" . $timestamp . ".png'\n");
fwrite($fh, 'set xtics rotate ("" 0 ');
$count = 1;
foreach (explode(':', $ResultIDs) as $i)
{
  if ($i == "") continue;

  $j = explode('@', $i);
  fwrite($fh, ', "' . $j[1] . '" ' . $count++ . " ");
}
fwrite($fh, ")\n");
fwrite($fh, 'set xrange [0:' . ($count + 1) . ']' . "\n");
fwrite($fh, "set boxwidth 1\n");
fwrite($fh, "set style fill solid\n");
fwrite($fh, "set nokey\n");
fwrite($fh, "set boxwidth 0.8\n");
fwrite($fh, "plot '-' using 1:2 w boxes\n");
$count = 1;
foreach (explode(':', $ResultIDs) as $i)
{
  if ($i == "") continue;

  $j = explode('@', $i);
  fwrite($fh, $count++ . " " . $j[0] . "\n");
}
fwrite($fh, "end\n");

fwrite($fh, "set output\n");
fwrite($fh, "set terminal pop\n");

fclose($fh); 

passthru('/usr/bin/gnuplot /tmp/gnuplot-' . $timestamp . ".dat 2>&1");

echo '<IMG SRC=../tmp/gnuplot-' . $timestamp . '.png>';

?>

<!-- end content ########################################################### -->

<?php include 'common/footer.html'; ?>
