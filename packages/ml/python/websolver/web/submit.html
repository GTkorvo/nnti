<?php 
  include 'common/header.php';
  include 'util.php';
  includeStyleSheet('styles.css'); 
  setFilename('submit.html');
  setTitle('Trilinos - WebSolver - Submit Page');
  setDir('./');
  include 'common/header.html';
?>

<!-- begin content ######################################################### -->

  <p class="heading">Trilinos WebSover - Submit Page</p>
        
  <!-- print form or process form? -->
  <?php if ($_POST['stage'] != 'processInput') {
    printInputForm();
  } else {
    processInputForm();
  } ?>

<!-- end content ########################################################### -->

<?php include 'common/footer.html'; ?>

<!-- ####################################################################### -->
<!-- PHP Functions
<!-- ####################################################################### -->

<!-- ####################################################################### -->
<!-- printInputForm() -->
<!-- ####################################################################### -->

<?php function printInputForm() { ?>

  <?php
  $timestamp=$_GET['timestamp'];
  $fileX=$_GET['filex'];
  $fileB=$_GET['fileb'];
  $structure=$_GET['structure'];
  $properties=$_GET['properties'];
  $smoother=explode(",", $_GET['smoother']); 
  $solver=explode(",", $_GET['solver']);
  $levels=$_GET['levels'];
  $aggregation=explode(",", $_GET['aggregation']);
  $prolongation=explode(",", $_GET['prolongation']);
  $krylov=explode(",", $_GET['krylov']);
  $iterations=$_GET['iterations'];
  ?>
  
  <table cellspacing="0" cellpadding="0" border="1">
    <tr><td>File A:</td><td><?php echo $fileA; ?>&nbsp;</td></tr>
    <tr><td>File X:</td><td><?php echo $fileX; ?>&nbsp;</td></tr>
    <tr><td>File B:</td><td><?php echo $fileB; ?>&nbsp;</td></tr>
    <tr><td>Structure:</td><td><?php echo $structure; ?>&nbsp;</td></tr>
    <tr><td>Properties:</td><td><?php echo $properties; ?>&nbsp;</td></tr>
    <tr><td>Smoothers:</td><td><?php foreach ($smoother as $item) { print "$item<br/>"; } ?>&nbsp;</td></tr>
    <tr><td>Coarse Grid Solvers:</td><td><?php foreach ($solver as $item) { print "$item<br/>"; } ?>&nbsp;</td></tr>
    <tr><td>Max Levels:</td><td><?php echo $levels; ?>&nbsp;</td></tr>
    <tr><td>Aggregation Methods:</td><td><?php foreach ($aggregation as $item) { print "$item<br/>"; } ?>&nbsp;</td></tr>
    <tr><td>Prolongation Methods:</td><td><?php foreach ($prolongation as $item) { print "$item<br/>"; } ?>&nbsp;</td></tr>
    <tr><td>Krylov Iterative Methods:</td><td><?php foreach ($krylov as $item) { print "$item<br/>"; } ?>&nbsp;</td></tr>
    <tr><td>Max Iterations:</td><td><?php echo $iterations; ?>&nbsp;</td></tr>
  </table>
  
  <?php
  
  $configString = "";
  $configString .= "SUBMIT_TIME = ".$timestamp."\n";
  $configString .= "EMAIL = \n";
  $configString .= "\n";
  $configString .= "A_FILE = /people_old/trilinos_www/htdocs/runs/$timestamp/a_file\n";
  $configString .= "X_FILE = ".($fileX=="yes"?"/people_old/trilinos_www/htdocs/runs/$timestamp/x_file":"")."\n";
  $configString .= "B_FILE = ".($fileB=="yes"?"/people_old/trilinos_www/htdocs/runs/$timestamp/b_file":"")."\n";
  $configString .= "\n";
  $configString .= "STRUCTURE = $structure\n";
  $configString .= "PROPERTIES = $properties\n";
  $configString .= "\n";
  $configString .= "SMOOHTER_TYPE = ".implode(',', $smoother)."\n";
  $configString .= "SMOOTHER_SWEEPS = \n";
  $configString .= "SMOOTHER_MLS_POLYNOMIAL_ORDER = \n";
  $configString .= "COARSE_TYPE = \n";
  $configString .= "COARSE_SWEEPS = \n";
  $configString .= "COARSE_MLS_POLYNOMIAL_ORDER = \n";
  $configString .= "SOLVER = ".implode(',', $solver)."\n";
  $configString .= "MAX_LEVELS = $levels\n";
  $configString .= "AGGREGATION_TYPE = ".implode(',', $aggregation)."\n";
  $configString .= "AGGREGATION_DAMPING_FACTOR = \n";
  $configString .= "PROLONGATION = ".implode(',', $prolongation)."\n";
  $configString .= "KRYLOV = ".implode(',', $krylov)."\n";
  $configString .= "ITERATIONS = $iterations\n";
  $configString .= "SOLVES = \n";
  
  $configFile = fopen("runs/$timestamp/config", 'w')
    or die("can't open runs/$timestamp/config: $php_errormsg");
  if (-1 == fwrite($configFile, $configString))
    { die("can't write to runs/$timestamp/config: $php_errormsg"); }
  fclose($configFile)
    or die("can't close runs/$timestamp/config: $php_errormsg");
  chmod("runs/$timestamp/config", 0664);
  
  chdir("/people_old/trilinos_www/Trilinos/packages/ml/python/websolver/");  
  ?><div class="outputBox"><pre><?php
  $command = "";
  $command .= "export LD_LIBRARY_PATH=/people_old/trilinos_www/shared-lib:\$LD_LIBRARY_PATH 2>&1 ; ";
  $command .= "python solve.py /people_old/trilinos_www/htdocs/runs/$timestamp/config 2>&1";
  passthru($command);
  ?>&nbsp;<pre></div><?php
  chdir("/people_old/trilinos_www/htdocs/"); 
  
  ?>
  
  <form action="#" enctype="multipart/form-data" method="post" name="inputForm">
  
    <!-- php marker for stage in form process -->
    <input type="hidden" name="stage" value="processInput">
  
    <table cellspacing="0" cellpadding="0"><tr>
      <td style="width: 30%; padding: 5px;">
        <input type="submit" name="solveitButton" value="Solve It" style="width: 100%;" /></td>
    </tr></table>

  </form>
  
<?php } ?> <!-- printInputForm() -->

<!-- ####################################################################### -->
<!-- processInputForm() -->
<!-- ####################################################################### -->

<?php function processInputForm() {

  
    
} ?> <!-- processInputForm() -->