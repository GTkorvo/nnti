#!/usr/bin/perl -w
#
# Once created by 'configure' this perl script can be run from anywhere!
#

use strict;

printf
  "\n*************************************************************************".
  "\n*** Running Thyra Operator/Vector serial tests (no news is good news) ***".
  "\n************************************************************************\n";

my $ierr = 0;
my $top_build_dir = remove_rel_paths("@abs_top_builddir@");

#
# Testing programs
#

my $test_dir = "${top_build_dir}/test/ana/operator_vector";

run_test("$test_dir/test_product_space.exe","--quiet","--verbose");
run_test("$test_dir/test_composite_linear_ops.exe --use-serial","--quiet","--verbose");
run_test("$test_dir/test_composite_linear_ops.exe --use-mpi","--quiet","--verbose");
run_test("$test_dir/test_scalar_product.exe","--quiet","--verbose");
run_test("$test_dir/test_std_ops.exe","--quiet","--verbose");

#
# Example programs
#

my $example_dir = "${top_build_dir}/example/ana/operator_vector";

run_test("$example_dir/sillyCgSolve_serial.exe","--quiet","--verbose");
run_test("$example_dir/sillyCgSolve_serial.exe --unsym-op --diag-scale=1.05","--quiet","--verbose");
run_test("$example_dir/sillyCgSolve_mpi.exe","--quiet","--verbose");
run_test("$example_dir/sillyPowerMethod_serial.exe","--quiet","--verbose");

if($ierr) {
  print "\n***\n*** Oh no, at least one of the Thyra Operator/Vector testing programs failed!\n***\n";
}
else {
  print "\n***\n*** Congratulations, All tests in the Thyra Operator/Vector collection seemed to have passed!\n***\n";
}

exit($ierr);

#
# Subroutines
#
sub run_test {
  my $cmnd = shift;
  my $quiet = shift;
  my $verbose = shift;
  my $cmnd_quiet = "$cmnd $quiet";
  print
    "\n****************************************************\n",
    "Running the following testing program in quiet mode:\n\n",
    "$cmnd_quiet ...\n";
  my $iresult = system($cmnd_quiet);
  $ierr += $iresult;
  print "\nThe above testing program passed!\n" if($iresult==0);
  print "\nThe above testing program failed!\n" if($iresult!=0);
  if($iresult!=0) {
    my $cmnd_verbose = "$cmnd $verbose";
    print
      "\n***************************************************\n",
      "Rerunning the this testing program in verbose mode:\n\n",
      "$cmnd_verbose ...\n";
    system($cmnd_verbose);
  }
}
#
sub remove_rel_paths {
	my $entry_in = shift;
	if ($entry_in=~/-L\.\./) {
		return $entry_in;
	}
	my @paths = split("/",$entry_in);
	my @new_paths;
	foreach( @paths ) {
		if( !($_=~/\.\./) ) {
			push @new_paths, $_;
		}
		else {
			pop @new_paths
		}
	}
	return join("/",@new_paths);
}
